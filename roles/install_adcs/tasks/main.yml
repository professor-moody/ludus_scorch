---
# Install AD CS for LDAPS support

- name: Install AD CS Role
  ansible.windows.win_feature:
    name:
      - AD-Certificate
      - ADCS-Cert-Authority
      - ADCS-Web-Enrollment
    state: present
    include_management_tools: true
  register: adcs_install

- name: Reboot if required after AD CS install
  ansible.windows.win_reboot:
    reboot_timeout: 600
  when: adcs_install.reboot_required

- name: Check if CA is already configured
  ansible.windows.win_shell: |
    try {
      $ca = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration' -ErrorAction Stop
      if ($ca) { Write-Output "configured" }
    } catch {
      Write-Output "not_configured"
    }
  register: ca_status
  changed_when: false

- name: Configure Enterprise Root CA
  ansible.windows.win_shell: |
    Install-AdcsCertificationAuthority `
      -CAType EnterpriseRootCa `
      -CACommonName "{{ ludus_domain_netbios_name | default('YOURNAMESPACE') }}-ROOT-CA" `
      -KeyLength 2048 `
      -HashAlgorithm SHA256 `
      -CryptoProviderName "RSA#Microsoft Software Key Storage Provider" `
      -ValidityPeriod Years `
      -ValidityPeriodUnits 10 `
      -Force
  when: ca_status.stdout | trim == "not_configured"
  register: ca_config
  failed_when: false

- name: Configure Web Enrollment
  ansible.windows.win_shell: |
    Install-AdcsWebEnrollment -Force
  when: ca_status.stdout | trim == "not_configured"
  failed_when: false

- name: Restart Certificate Services
  ansible.windows.win_service:
    name: CertSvc
    state: restarted
  when: ca_config.changed | default(false)

- name: Wait for LDAPS certificate to be issued
  ansible.windows.win_shell: |
    $count = 0
    while ($count -lt 30) {
      $cert = Get-ChildItem -Path Cert:\LocalMachine\My | Where-Object { $_.Subject -like "*{{ ansible_hostname }}*" }
      if ($cert) {
        Write-Output "Certificate found"
        exit 0
      }
      Start-Sleep -Seconds 10
      $count++
    }
    Write-Output "Timeout waiting for certificate"
  register: ldaps_cert
  changed_when: false
