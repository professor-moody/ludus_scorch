---
# Install SCORCH prerequisites

- name: Create temp directory for installers
  ansible.windows.win_file:
    path: "{{ ludus_scorch_temp_dir }}"
    state: directory

- name: Install .NET Framework 3.5
  ansible.windows.win_feature:
    name: NET-Framework-Core
    state: present
    include_sub_features: true
  when: ludus_scorch_install_dotnet35
  register: dotnet35_install

- name: Install .NET Framework 4.x Features
  ansible.windows.win_feature:
    name:
      - NET-Framework-45-Features
      - NET-Framework-45-Core
      - NET-Framework-45-ASPNET
      - NET-WCF-Services45
    state: present
    include_sub_features: true
  when: ludus_scorch_install_dotnet472
  register: dotnet4_install

- name: Install IIS and required features
  ansible.windows.win_feature:
    name: "{{ ludus_scorch_iis_features }}"
    state: present
    include_management_tools: true
  when: ludus_scorch_install_iis
  register: iis_install

- name: Reboot if required after feature installation
  ansible.windows.win_reboot:
    reboot_timeout: 600
  when: (dotnet35_install.reboot_required | default(false)) or 
        (dotnet4_install.reboot_required | default(false)) or 
        (iis_install.reboot_required | default(false))

- name: Download Visual C++ Redistributable
  ansible.windows.win_get_url:
    url: "{{ ludus_scorch_vcredist_url }}"
    dest: "{{ ludus_scorch_temp_dir }}\\vc_redist.x64.exe"
    force: false
  when: ludus_scorch_install_vcredist
  register: vcredist_download

- name: Install Visual C++ Redistributable
  ansible.windows.win_package:
    path: "{{ ludus_scorch_temp_dir }}\\vc_redist.x64.exe"
    arguments: /quiet /norestart
    state: present
    product_id: '{A0D8E9D7-59E5-44F7-9E9D-7E7AC3E0E4F9}'
  when: ludus_scorch_install_vcredist
  register: vcredist_install
  failed_when: false

# Microsoft OLE DB Driver for SQL Server v18 - REQUIRED for SCORCH 2022
# Note: v19 causes DBSetup.exe to crash with access violation
- name: Download Microsoft OLE DB Driver v18
  ansible.windows.win_get_url:
    url: "{{ ludus_scorch_msoledbsql_url }}"
    dest: "{{ ludus_scorch_temp_dir }}\\msoledbsql.msi"
    force: false
  when: ludus_scorch_install_msoledbsql
  register: msoledbsql_download

- name: Install Microsoft OLE DB Driver v18
  ansible.windows.win_package:
    path: "{{ ludus_scorch_temp_dir }}\\msoledbsql.msi"
    arguments: /quiet /norestart IACCEPTMSOLEDBSQLLICENSETERMS=YES
    state: present
  when: ludus_scorch_install_msoledbsql
  register: msoledbsql_install
  failed_when: false

- name: Download .NET 5 Hosting Bundle
  ansible.windows.win_get_url:
    url: "{{ ludus_scorch_dotnet5_hosting_url }}"
    dest: "{{ ludus_scorch_temp_dir }}\\dotnet-hosting-5.0.exe"
    force: false
  when: ludus_scorch_install_dotnet_hosting
  register: hosting5_download

- name: Install .NET 5 Hosting Bundle
  ansible.windows.win_package:
    path: "{{ ludus_scorch_temp_dir }}\\dotnet-hosting-5.0.exe"
    arguments: /install /quiet /norestart
    state: present
  when: ludus_scorch_install_dotnet_hosting
  register: hosting5_install
  failed_when: false

- name: Download .NET 6 Hosting Bundle
  ansible.windows.win_get_url:
    url: "{{ ludus_scorch_dotnet6_hosting_url }}"
    dest: "{{ ludus_scorch_temp_dir }}\\dotnet-hosting-6.0.exe"
    force: false
  when: ludus_scorch_install_dotnet_hosting
  register: hosting6_download

- name: Install .NET 6 Hosting Bundle
  ansible.windows.win_package:
    path: "{{ ludus_scorch_temp_dir }}\\dotnet-hosting-6.0.exe"
    arguments: /install /quiet /norestart
    state: present
  when: ludus_scorch_install_dotnet_hosting
  register: hosting6_install
  failed_when: false

- name: Restart IIS after hosting bundle install
  ansible.windows.win_shell: |
    if (Get-Service -Name W3SVC -ErrorAction SilentlyContinue) {
      iisreset /restart
    }
  when: (hosting5_install.changed | default(false)) or (hosting6_install.changed | default(false))
  failed_when: false

- name: Download IIS URL Rewrite Module
  ansible.windows.win_get_url:
    url: "{{ ludus_scorch_urlrewrite_url }}"
    dest: "{{ ludus_scorch_temp_dir }}\\urlrewrite.msi"
    force: false
  when: ludus_scorch_install_iis_modules

- name: Install IIS URL Rewrite Module
  ansible.windows.win_package:
    path: "{{ ludus_scorch_temp_dir }}\\urlrewrite.msi"
    state: present
  when: ludus_scorch_install_iis_modules
  failed_when: false

- name: Download IIS CORS Module
  ansible.windows.win_get_url:
    url: "{{ ludus_scorch_cors_url }}"
    dest: "{{ ludus_scorch_temp_dir }}\\iiscors.msi"
    force: false
  when: ludus_scorch_install_iis_modules

- name: Install IIS CORS Module
  ansible.windows.win_package:
    path: "{{ ludus_scorch_temp_dir }}\\iiscors.msi"
    state: present
  when: ludus_scorch_install_iis_modules
  failed_when: false

- name: Configure Windows Firewall rules
  community.windows.win_firewall_rule:
    name: "{{ item.name }}"
    localport: "{{ item.port }}"
    action: allow
    direction: in
    protocol: "{{ item.protocol }}"
    state: present
    enabled: true
  loop: "{{ ludus_scorch_firewall_ports }}"

- name: Enable Remote Event Log Management firewall rules
  community.windows.win_firewall_rule:
    name: "Remote Event Log Management (RPC)"
    enabled: true
    state: present
  failed_when: false

- name: Enable WMI firewall rules
  ansible.windows.win_shell: |
    netsh advfirewall firewall set rule group="Windows Management Instrumentation (WMI)" new enable=yes
  failed_when: false

- name: Verify prerequisites installed
  ansible.windows.win_shell: |
    $results = @{
      DotNet35 = (Get-WindowsFeature NET-Framework-Core).Installed
      DotNet45 = (Get-WindowsFeature NET-Framework-45-Core).Installed
      IIS = (Get-WindowsFeature Web-Server).Installed
      WCF = (Get-WindowsFeature NET-WCF-HTTP-Activation45).Installed
      MSOLEDBSQL = (Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\MSOLEDBSQL" -ErrorAction SilentlyContinue).InstalledVersion
    }
    $results | ConvertTo-Json
  register: prereq_check
  changed_when: false

- name: Display prerequisite status
  ansible.builtin.debug:
    msg: "Prerequisites: {{ prereq_check.stdout }}"
