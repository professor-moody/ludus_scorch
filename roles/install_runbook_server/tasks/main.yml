---
# Install SCORCH Runbook Server (standalone)

- name: Set computed variables
  ansible.builtin.set_fact:
    ludus_scorch_service_account_full: "{{ ludus_domain_netbios_name | default('YOURNAMESPACE') }}\\{{ ludus_scorch_svc_account }}"
    ludus_scorch_db_connection: "{{ ludus_scorch_db_server }}{% if ludus_scorch_db_instance | length > 0 %}\\{{ ludus_scorch_db_instance }}{% endif %}"

- name: Create temp directory
  ansible.windows.win_file:
    path: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}"
    state: directory

- name: Check if SCORCH Runbook Server is already installed
  ansible.windows.win_service_info:
    name: OrchestratorRunbook
  register: scorch_rb_service
  failed_when: false

- name: Skip installation if already installed
  ansible.builtin.debug:
    msg: "SCORCH Runbook Server is already installed"
  when: scorch_rb_service.services | length > 0

# Check if setup already exists
- name: Check if SCORCH setup already extracted
  ansible.windows.win_find:
    paths: "{{ ludus_scorch_setup_folder }}"
    patterns: "SetupOrchestrator.exe"
    recurse: yes
  register: existing_setup
  when: scorch_rb_service.services | length == 0
  failed_when: false

# Download if needed
- name: Create ludus directory
  ansible.windows.win_file:
    path: "C:\\ludus"
    state: directory
  when:
    - scorch_rb_service.services | length == 0
    - existing_setup.files | default([]) | length == 0

- name: Download SCORCH setup from Microsoft
  ansible.windows.win_get_url:
    url: "{{ ludus_scorch_download_url }}"
    dest: "{{ ludus_scorch_setup_zip }}"
    force: no
  when:
    - scorch_rb_service.services | length == 0
    - existing_setup.files | default([]) | length == 0

- name: Create SCORCH setup folder
  ansible.windows.win_file:
    path: "{{ ludus_scorch_setup_folder }}"
    state: directory
  when:
    - scorch_rb_service.services | length == 0
    - existing_setup.files | default([]) | length == 0

- name: Extract SCORCH zip file
  community.windows.win_unzip:
    src: "{{ ludus_scorch_setup_zip }}"
    dest: "{{ ludus_scorch_setup_folder }}"
  when:
    - scorch_rb_service.services | length == 0
    - existing_setup.files | default([]) | length == 0

# Find Setup.exe (in CdImage/Setup subfolder - required for silent install)
- name: Find Setup.exe
  ansible.windows.win_find:
    paths: "{{ ludus_scorch_setup_folder }}"
    patterns: "Setup.exe"
    recurse: yes
  register: setup_exe_find
  when: scorch_rb_service.services | length == 0

- name: Fail if Setup.exe not found
  ansible.builtin.fail:
    msg: "Setup.exe not found in {{ ludus_scorch_setup_folder }}"
  when:
    - scorch_rb_service.services | length == 0
    - setup_exe_find.files | length == 0

- name: Set SCORCH setup path
  ansible.builtin.set_fact:
    ludus_scorch_setup_path: "{{ setup_exe_find.files[0].path }}"
  when:
    - scorch_rb_service.services | length == 0
    - setup_exe_find.files | length > 0

- name: Add service account to local Administrators
  ansible.windows.win_group_membership:
    name: Administrators
    members:
      - "{{ ludus_scorch_service_account_full }}"
    state: present
  failed_when: false

- name: Grant Log on as a Service right
  ansible.windows.win_user_right:
    name: SeServiceLogonRight
    users:
      - "{{ ludus_scorch_service_account_full }}"
    action: add

# =============================================================================
# SCORCH INSTALLATION - Using Scheduled Task for Interactive Session
# =============================================================================

- name: Create temp directory
  ansible.windows.win_file:
    path: "{{ ludus_scorch_temp_dir | default('C:\\ludus_scorch_temp') }}"
    state: directory
  when: scorch_rb_service.services | length == 0

- name: Create SCORCH Runbook Server install script
  ansible.windows.win_copy:
    dest: "{{ ludus_scorch_temp_dir | default('C:\\ludus_scorch_temp') }}\\Install-SCORCH-RB.ps1"
    content: |
      $ErrorActionPreference = "Stop"
      $logFile = "{{ ludus_scorch_temp_dir | default('C:\\ludus_scorch_temp') }}\scorch_rb_install.log"
      
      Start-Transcript -Path $logFile -Append
      
      $env:SEE_MASK_NOZONECHECKS = 1
      
      $setupPath = "{{ ludus_scorch_setup_path }}"
      
      $args = @(
        '/Silent',
        '/ServiceUserName:{{ ludus_scorch_service_account_full }}',
        '/ServicePassword:{{ ludus_scorch_svc_password }}',
        '/Components:{{ ludus_scorch_components }}',
        '/DbServer:{{ ludus_scorch_db_connection }}',
        '/DbNameExisting:{{ ludus_scorch_db_name }}',
        '/TrustServerCertificate:{{ ludus_scorch_db_trust_cert | lower }}',
        '/UseMicrosoftUpdate:{% if ludus_scorch_use_microsoft_update %}1{% else %}0{% endif %}',
        '/SendTelemetryReports:{% if ludus_scorch_send_telemetry %}1{% else %}0{% endif %}',
        '/EnableErrorReporting:{{ ludus_scorch_error_reporting }}'
      )
      
      Write-Output "Starting SCORCH Runbook Server installation..."
      Write-Output "Setup path: $setupPath"
      Write-Output "Arguments: $($args -join ' ')"
      
      try {
        $process = Start-Process -FilePath $setupPath -ArgumentList $args -Wait -PassThru -NoNewWindow
        $exitCode = $process.ExitCode
        Write-Output "Installation completed with exit code: $exitCode"
        $exitCode | Out-File -FilePath "{{ ludus_scorch_temp_dir | default('C:\\ludus_scorch_temp') }}\scorch_rb_exit_code.txt" -Force
        Stop-Transcript
        exit $exitCode
      } catch {
        Write-Error "Installation failed: $_"
        999 | Out-File -FilePath "{{ ludus_scorch_temp_dir | default('C:\\ludus_scorch_temp') }}\scorch_rb_exit_code.txt" -Force
        Stop-Transcript
        exit 999
      }
  when: scorch_rb_service.services | length == 0

- name: Remove any existing SCORCH RB install scheduled task
  community.windows.win_scheduled_task:
    name: "SCORCH_RB_Install"
    state: absent
  when: scorch_rb_service.services | length == 0

- name: Create scheduled task for SCORCH Runbook Server installation
  community.windows.win_scheduled_task:
    name: "SCORCH_RB_Install"
    description: "Install SCORCH Runbook Server in interactive session"
    actions:
      - path: powershell.exe
        arguments: '-ExecutionPolicy Bypass -File "{{ ludus_scorch_temp_dir | default(''C:\\ludus_scorch_temp'') }}\Install-SCORCH-RB.ps1"'
    triggers:
      - type: registration
    username: '{{ ludus_domain_fqdn }}\{{ defaults.ad_domain_admin }}'
    password: '{{ defaults.ad_domain_admin_password }}'
    logon_type: interactive_token
    run_level: highest
    state: present
    enabled: true
  when: scorch_rb_service.services | length == 0
  register: sched_task_created

- name: Run the SCORCH RB install scheduled task
  ansible.windows.win_shell: |
    Start-ScheduledTask -TaskName "SCORCH_RB_Install"
  when: 
    - scorch_rb_service.services | length == 0
    - sched_task_created is changed

- name: Wait for SCORCH RB installation to complete
  ansible.windows.win_wait_for:
    path: "{{ ludus_scorch_temp_dir | default('C:\\ludus_scorch_temp') }}\\scorch_rb_exit_code.txt"
    timeout: 3600
  when: scorch_rb_service.services | length == 0

- name: Get installation exit code
  ansible.windows.win_shell: |
    Get-Content "{{ ludus_scorch_temp_dir | default('C:\\ludus_scorch_temp') }}\scorch_rb_exit_code.txt"
  register: install_exit_code
  when: scorch_rb_service.services | length == 0

- name: Check installation result
  ansible.builtin.fail:
    msg: "SCORCH Runbook Server installation failed with exit code: {{ install_exit_code.stdout | trim }}"
  when:
    - scorch_rb_service.services | length == 0
    - install_exit_code.stdout | trim not in ['0', '3010']

- name: Remove SCORCH RB install scheduled task
  community.windows.win_scheduled_task:
    name: "SCORCH_RB_Install"
    state: absent
  when: scorch_rb_service.services | length == 0

- name: Wait for Runbook Server service to start
  ansible.windows.win_service:
    name: OrchestratorRunbook
    state: started
    start_mode: auto
  register: rb_service
  retries: 10
  delay: 30
  until: rb_service is succeeded

- name: Verify Runbook Server is running
  ansible.windows.win_shell: |
    $service = Get-Service -Name OrchestratorRunbook
    Write-Output "Runbook Server Status: $($service.Status)"
  register: rb_verify
  changed_when: false

- name: Display installation status
  ansible.builtin.debug:
    msg: "{{ rb_verify.stdout }}"
