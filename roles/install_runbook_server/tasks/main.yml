---
# Install SCORCH Runbook Server (standalone)

- name: Set computed variables
  ansible.builtin.set_fact:
    ludus_scorch_service_account_full: "{{ ludus_domain_netbios_name | default('YOURNAMESPACE') }}\\{{ ludus_scorch_svc_account }}"
    ludus_scorch_db_connection: "{{ ludus_scorch_db_server }}{% if ludus_scorch_db_instance | length > 0 %}\\{{ ludus_scorch_db_instance }}{% endif %}"

- name: Create temp directory
  ansible.windows.win_file:
    path: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}"
    state: directory

- name: Check if SCORCH Runbook Server is already installed
  ansible.windows.win_service_info:
    name: OrchestratorRunbook
  register: scorch_rb_service
  failed_when: false

- name: Skip installation if already installed
  ansible.builtin.debug:
    msg: "SCORCH Runbook Server is already installed"
  when: scorch_rb_service.services | length > 0

- name: Check if SCORCH ISO exists
  ansible.windows.win_stat:
    path: "{{ ludus_scorch_iso_path }}"
  register: scorch_iso_stat
  when: scorch_rb_service.services | length == 0

- name: Fail if SCORCH ISO not found
  ansible.builtin.fail:
    msg: "SCORCH ISO not found at {{ ludus_scorch_iso_path }}"
  when:
    - scorch_rb_service.services | length == 0
    - not scorch_iso_stat.stat.exists | default(false)

- name: Mount SCORCH ISO
  community.windows.win_disk_image:
    image_path: "{{ ludus_scorch_iso_path }}"
    state: present
  register: scorch_iso_mount
  when: scorch_rb_service.services | length == 0

- name: Set SCORCH setup path
  ansible.builtin.set_fact:
    ludus_scorch_setup_path: "{{ scorch_iso_mount.mount_paths[0] }}SetupOrchestrator.exe"
  when: scorch_iso_mount.mount_paths is defined

- name: Add service account to local Administrators
  ansible.windows.win_group_membership:
    name: Administrators
    members:
      - "{{ ludus_scorch_service_account_full }}"
    state: present
  failed_when: false

- name: Grant Log on as a Service right
  ansible.windows.win_user_right:
    name: SeServiceLogonRight
    users:
      - "{{ ludus_scorch_service_account_full }}"
    action: add

- name: Install SCORCH Runbook Server
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"
    $env:SEE_MASK_NOZONECHECKS = 1
    
    $args = @(
      '/Silent',
      '/ServiceUserName:{{ ludus_scorch_service_account_full }}',
      '/ServicePassword:{{ ludus_scorch_svc_password }}',
      '/Components:{{ ludus_scorch_components }}',
      '/DbServer:{{ ludus_scorch_db_connection }}',
      '/DbNameExisting:{{ ludus_scorch_db_name }}',
      '/TrustServerCertificate:{{ ludus_scorch_db_trust_cert | lower }}',
      '/UseMicrosoftUpdate:{% if ludus_scorch_use_microsoft_update %}1{% else %}0{% endif %}',
      '/SendTelemetryReports:{% if ludus_scorch_send_telemetry %}1{% else %}0{% endif %}',
      '/EnableErrorReporting:{{ ludus_scorch_error_reporting }}'
    )
    
    Write-Output "Starting SCORCH Runbook Server installation..."
    
    $process = Start-Process -FilePath "{{ ludus_scorch_setup_path }}" `
      -ArgumentList $args `
      -Wait -PassThru -NoNewWindow
    
    if ($process.ExitCode -eq 0 -or $process.ExitCode -eq 3010) {
      Write-Output "SCORCH Runbook Server installed successfully"
      exit 0
    } else {
      Write-Error "Installation failed with exit code: $($process.ExitCode)"
      exit $process.ExitCode
    }
  when: scorch_rb_service.services | length == 0
  register: scorch_install
  async: 3600
  poll: 60

- name: Unmount SCORCH ISO
  community.windows.win_disk_image:
    image_path: "{{ ludus_scorch_iso_path }}"
    state: absent
  when: scorch_iso_mount.mount_paths is defined

- name: Wait for Runbook Server service to start
  ansible.windows.win_service:
    name: OrchestratorRunbook
    state: started
    start_mode: auto
  register: rb_service
  retries: 10
  delay: 30
  until: rb_service is succeeded

- name: Verify Runbook Server is running
  ansible.windows.win_shell: |
    $service = Get-Service -Name OrchestratorRunbook
    Write-Output "Runbook Server Status: $($service.Status)"
  register: rb_verify
  changed_when: false

- name: Display installation status
  ansible.builtin.debug:
    msg: "{{ rb_verify.stdout }}"
