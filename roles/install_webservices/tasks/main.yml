---
# Install SCORCH Web API and Console

- name: Set computed variables
  ansible.builtin.set_fact:
    ludus_scorch_web_account_full: "{{ ludus_domain_netbios_name | default('YOURNAMESPACE') }}\\{{ ludus_scorch_web_account }}"
    ludus_scorch_db_connection: "{{ ludus_scorch_db_server }}{% if ludus_scorch_db_instance | length > 0 %}\\{{ ludus_scorch_db_instance }}{% endif %}"
    ludus_scorch_api_url: "{{ ludus_scorch_api_public_url | default('http://' + ansible_fqdn + ':' + ludus_scorch_api_port | string) }}"
    ludus_scorch_console_url: "{{ ludus_scorch_console_public_url | default('http://' + ansible_fqdn + ':' + ludus_scorch_console_port | string) }}"

- name: Create temp directory
  ansible.windows.win_file:
    path: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}"
    state: directory

# =============================================================================
# PREREQUISITES - SCORCH 2022 requires VC++ 2015-2022 and .NET 6 Hosting Bundle
# =============================================================================
- name: Check if VC++ Redistributable is installed
  ansible.windows.win_shell: |
    $vcRedist = Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\VisualStudio\14.0\VC\Runtimes\X64" -ErrorAction SilentlyContinue
    if ($vcRedist -and $vcRedist.Version -ge "14.34") { Write-Output "installed" } else { Write-Output "not_installed" }
  register: vcredist_check
  changed_when: false

- name: Download Visual C++ Redistributable 2015-2022
  ansible.windows.win_get_url:
    url: "https://aka.ms/vs/17/release/vc_redist.x64.exe"
    dest: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\vc_redist.x64.exe"
  when: vcredist_check.stdout | trim == "not_installed"

- name: Install Visual C++ Redistributable 2015-2022
  ansible.windows.win_package:
    path: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\vc_redist.x64.exe"
    arguments: /install /quiet /norestart
    state: present
  when: vcredist_check.stdout | trim == "not_installed"
  register: vcredist_install

- name: Check if .NET 6 Hosting Bundle is installed
  ansible.windows.win_shell: |
    $dotnet6 = Get-ItemProperty "HKLM:\SOFTWARE\dotnet\Setup\InstalledVersions\x64\sharedfx\Microsoft.AspNetCore.App" -ErrorAction SilentlyContinue
    if ($dotnet6) { Write-Output "installed" } else { Write-Output "not_installed" }
  register: dotnet6_check
  changed_when: false

# IIS must be installed BEFORE .NET 6 Hosting Bundle for ASP.NET Core module registration
- name: Install IIS with required features
  ansible.windows.win_feature:
    name:
      - Web-Server
      - Web-WebServer
      - Web-Common-Http
      - Web-Default-Doc
      - Web-Dir-Browsing
      - Web-Http-Errors
      - Web-Static-Content
      - Web-Health
      - Web-Http-Logging
      - Web-Performance
      - Web-Stat-Compression
      - Web-Security
      - Web-Filtering
      - Web-Windows-Auth
      - Web-App-Dev
      - Web-Net-Ext45
      - Web-Asp-Net45
      - Web-ISAPI-Ext
      - Web-ISAPI-Filter
      - Web-Mgmt-Tools
      - Web-Mgmt-Console
      - NET-Framework-45-ASPNET
      - NET-WCF-HTTP-Activation45
    state: present
  register: iis_install

- name: Download .NET 6 Hosting Bundle
  ansible.windows.win_get_url:
    url: "https://builds.dotnet.microsoft.com/dotnet/aspnetcore/Runtime/6.0.36/dotnet-hosting-6.0.36-win.exe"
    dest: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\dotnet-hosting-6.0.exe"
  when: dotnet6_check.stdout | trim == "not_installed"

- name: Install .NET 6 Hosting Bundle
  ansible.windows.win_package:
    path: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\dotnet-hosting-6.0.exe"
    arguments: /install /quiet /norestart
    state: present
  when: dotnet6_check.stdout | trim == "not_installed"
  register: dotnet6_install

# Microsoft OLE DB Driver for SQL Server v18 - Required for Web API Service
- name: Check if OLE DB Driver is installed
  ansible.windows.win_shell: |
    $oledb = Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\MSOLEDBSQL" -ErrorAction SilentlyContinue
    if ($oledb) { Write-Output "installed" } else { Write-Output "not_installed" }
  register: oledb_check
  changed_when: false

- name: Download Microsoft OLE DB Driver for SQL Server
  ansible.windows.win_get_url:
    url: "https://go.microsoft.com/fwlink/?linkid=2242656"
    dest: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\msoledbsql.msi"
  when: oledb_check.stdout | trim == "not_installed"

- name: Install Microsoft OLE DB Driver for SQL Server
  ansible.windows.win_package:
    path: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\msoledbsql.msi"
    arguments: /quiet /norestart IACCEPTMSOLEDBSQLLICENSETERMS=YES
    state: present
  when: oledb_check.stdout | trim == "not_installed"
  register: oledb_install

# IIS URL Rewrite Module - Required for Orchestration Console
- name: Check if IIS URL Rewrite is installed
  ansible.windows.win_shell: |
    $urlRewrite = Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\IIS Extensions\URL Rewrite" -ErrorAction SilentlyContinue
    if ($urlRewrite) { Write-Output "installed" } else { Write-Output "not_installed" }
  register: urlrewrite_check
  changed_when: false

- name: Download IIS URL Rewrite Module
  ansible.windows.win_get_url:
    url: "https://download.microsoft.com/download/1/2/8/128E2E22-C1B9-44A4-BE2A-5859ED1D4592/rewrite_amd64_en-US.msi"
    dest: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\rewrite_amd64.msi"
  when: urlrewrite_check.stdout | trim == "not_installed"

- name: Install IIS URL Rewrite Module
  ansible.windows.win_package:
    path: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\rewrite_amd64.msi"
    arguments: /quiet /norestart
    state: present
  when: urlrewrite_check.stdout | trim == "not_installed"
  register: urlrewrite_install

# IIS CORS Module - Required for Web API Service
- name: Check if IIS CORS Module is installed
  ansible.windows.win_shell: |
    $cors = Get-WebConfigurationProperty -pspath 'MACHINE/WEBROOT/APPHOST' -filter "system.webServer/cors" -name "." -ErrorAction SilentlyContinue
    if ($cors) { Write-Output "installed" } else { Write-Output "not_installed" }
  register: cors_check
  changed_when: false
  ignore_errors: true

- name: Download IIS CORS Module
  ansible.windows.win_get_url:
    url: "https://download.microsoft.com/download/A/D/3/AD3D89DA-BEEF-4F25-9776-3AAB624AB60E/iiscors_amd64.msi"
    dest: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\iiscors_amd64.msi"
  when: cors_check.stdout | default('not_installed') | trim == "not_installed"

- name: Install IIS CORS Module
  ansible.windows.win_package:
    path: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\iiscors_amd64.msi"
    arguments: /quiet /norestart
    state: present
  when: cors_check.stdout | default('not_installed') | trim == "not_installed"
  register: cors_install

- name: Reboot if prerequisites were installed
  ansible.windows.win_reboot:
    reboot_timeout: 600
  when: (vcredist_install.changed | default(false)) or (iis_install.changed | default(false)) or (dotnet6_install.changed | default(false)) or (oledb_install.changed | default(false)) or (urlrewrite_install.changed | default(false)) or (cors_install.changed | default(false))

- name: Check if SCORCH Web Services are already installed
  ansible.windows.win_shell: |
    $site = Get-Website -Name "Microsoft System Center*Orchestrator*" -ErrorAction SilentlyContinue
    if ($site) { Write-Output "installed" } else { Write-Output "not_installed" }
  register: scorch_web_check
  changed_when: false

- name: Skip installation if already installed
  ansible.builtin.debug:
    msg: "SCORCH Web Services are already installed"
  when: scorch_web_check.stdout | trim == "installed"

# Check if setup already exists
- name: Check if SCORCH setup already extracted
  ansible.windows.win_find:
    paths: "{{ ludus_scorch_setup_folder }}"
    patterns: "SetupOrchestrator.exe"
    recurse: yes
  register: existing_setup
  when: scorch_web_check.stdout | trim == "not_installed"
  failed_when: false

# Download if needed
- name: Create ludus directory
  ansible.windows.win_file:
    path: "C:\\ludus"
    state: directory
  when:
    - scorch_web_check.stdout | trim == "not_installed"
    - existing_setup.files | default([]) | length == 0

- name: Download SCORCH setup from Microsoft
  ansible.windows.win_get_url:
    url: "{{ ludus_scorch_download_url }}"
    dest: "{{ ludus_scorch_setup_zip }}"
    force: no
  when:
    - scorch_web_check.stdout | trim == "not_installed"
    - existing_setup.files | default([]) | length == 0

- name: Create SCORCH setup folder
  ansible.windows.win_file:
    path: "{{ ludus_scorch_setup_folder }}"
    state: directory
  when:
    - scorch_web_check.stdout | trim == "not_installed"
    - existing_setup.files | default([]) | length == 0

- name: Extract SCORCH zip file
  community.windows.win_unzip:
    src: "{{ ludus_scorch_setup_zip }}"
    dest: "{{ ludus_scorch_setup_folder }}"
  when:
    - scorch_web_check.stdout | trim == "not_installed"
    - existing_setup.files | default([]) | length == 0

# Find SetupOrchestrator.exe (in CdImage subfolder)
- name: Find SetupOrchestrator.exe
  ansible.windows.win_find:
    paths: "{{ ludus_scorch_setup_folder }}"
    patterns: "SetupOrchestrator.exe"
    recurse: yes
  register: setup_exe_find
  when: scorch_web_check.stdout | trim == "not_installed"

- name: Fail if SetupOrchestrator.exe not found
  ansible.builtin.fail:
    msg: "SetupOrchestrator.exe not found in {{ ludus_scorch_setup_folder }}"
  when:
    - scorch_web_check.stdout | trim == "not_installed"
    - setup_exe_find.files | length == 0

- name: Set SCORCH setup path
  ansible.builtin.set_fact:
    ludus_scorch_setup_path: "{{ setup_exe_find.files[0].path }}"
  when:
    - scorch_web_check.stdout | trim == "not_installed"
    - setup_exe_find.files | length > 0

- name: Add web service account to local Administrators
  ansible.windows.win_group_membership:
    name: Administrators
    members:
      - "{{ ludus_scorch_web_account_full }}"
    state: present
  failed_when: false

- name: Grant Log on as a Service right
  ansible.windows.win_user_right:
    name: SeServiceLogonRight
    users:
      - "{{ ludus_scorch_web_account_full }}"
    action: add

- name: Grant IIS Metabase permissions
  ansible.windows.win_shell: |
    $path = "C:\Windows\Microsoft.NET\Framework64\v4.0.30319\aspnet_regiis.exe"
    if (Test-Path $path) {
      & $path -ga "{{ ludus_scorch_web_account_full }}"
    }
  failed_when: false

- name: Install SCORCH Web API Service
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"
    $env:SEE_MASK_NOZONECHECKS = 1
    
    $args = @(
      '/Silent',
      '/ServiceUserName:{{ ludus_scorch_web_account_full }}',
      '/ServicePassword:{{ ludus_scorch_web_password }}',
      '/Components:WebAPI',
      '/DbServer:{{ ludus_scorch_db_connection }}',
      '/DbNameExisting:{{ ludus_scorch_db_name }}',
      '/TrustServerCertificate:{{ ludus_scorch_db_trust_cert | lower }}',
      '/WebServicePort:{{ ludus_scorch_api_port }}',
      '/WebConsolePublicUrl:"{{ ludus_scorch_console_url }}"',
      '/UseMicrosoftUpdate:{% if ludus_scorch_use_microsoft_update %}1{% else %}0{% endif %}',
      '/SendTelemetryReports:{% if ludus_scorch_send_telemetry %}1{% else %}0{% endif %}',
      '/EnableErrorReporting:{{ ludus_scorch_error_reporting }}'
    )
    
    Write-Output "Installing SCORCH Web API..."
    
    $process = Start-Process -FilePath "{{ ludus_scorch_setup_path }}" `
      -ArgumentList $args `
      -Wait -PassThru -NoNewWindow
    
    if ($process.ExitCode -eq 0 -or $process.ExitCode -eq 3010) {
      Write-Output "Web API installed successfully"
      exit 0
    } else {
      Write-Error "Installation failed with exit code: $($process.ExitCode)"
      exit $process.ExitCode
    }
  vars:
    ansible_become: true
    ansible_become_method: runas
    ansible_become_user: '{{ ludus_domain_fqdn }}\{{ defaults.ad_domain_admin }}'
    ansible_become_password: '{{ defaults.ad_domain_admin_password }}'
    ansible_become_flags: "logon_type=interactive logon_flags=with_profile"
  when: scorch_web_check.stdout | trim == "not_installed"
  register: webapi_install
  async: 1800
  poll: 60

- name: Install SCORCH Orchestration Console
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"
    $env:SEE_MASK_NOZONECHECKS = 1
    
    $args = @(
      '/Silent',
      '/ServiceUserName:{{ ludus_scorch_web_account_full }}',
      '/ServicePassword:{{ ludus_scorch_web_password }}',
      '/Components:WebConsole',
      '/WebConsolePort:{{ ludus_scorch_console_port }}',
      '/WebServicePublicUrl:"{{ ludus_scorch_api_url }}"',
      '/UseMicrosoftUpdate:{% if ludus_scorch_use_microsoft_update %}1{% else %}0{% endif %}',
      '/SendTelemetryReports:{% if ludus_scorch_send_telemetry %}1{% else %}0{% endif %}',
      '/EnableErrorReporting:{{ ludus_scorch_error_reporting }}'
    )
    
    Write-Output "Installing SCORCH Orchestration Console..."
    
    $process = Start-Process -FilePath "{{ ludus_scorch_setup_path }}" `
      -ArgumentList $args `
      -Wait -PassThru -NoNewWindow
    
    if ($process.ExitCode -eq 0 -or $process.ExitCode -eq 3010) {
      Write-Output "Console installed successfully"
      exit 0
    } else {
      Write-Error "Installation failed with exit code: $($process.ExitCode)"
      exit $process.ExitCode
    }
  vars:
    ansible_become: true
    ansible_become_method: runas
    ansible_become_user: '{{ ludus_domain_fqdn }}\{{ defaults.ad_domain_admin }}'
    ansible_become_password: '{{ defaults.ad_domain_admin_password }}'
    ansible_become_flags: "logon_type=interactive logon_flags=with_profile"
  when: scorch_web_check.stdout | trim == "not_installed"
  register: console_install
  async: 1800
  poll: 60

- name: Configure anonymous access for testing
  ansible.windows.win_shell: |
    Import-Module WebAdministration
    
    # Find the SCORCH web site
    $site = Get-Website | Where-Object { $_.Name -like "*Orchestrator*Web*" } | Select-Object -First 1
    
    if ($site) {
      $sitePath = "IIS:\Sites\$($site.Name)"
      
      # Enable anonymous authentication
      Set-WebConfigurationProperty -Filter "/system.webServer/security/authentication/anonymousAuthentication" `
        -Name "enabled" -Value $true -PSPath $sitePath
      
      # Disable Windows authentication
      Set-WebConfigurationProperty -Filter "/system.webServer/security/authentication/windowsAuthentication" `
        -Name "enabled" -Value $false -PSPath $sitePath
      
      Write-Output "Anonymous access enabled for $($site.Name)"
    }
  when: ludus_scorch_enable_anonymous_access

- name: Configure NTLM without channel binding (for relay testing)
  ansible.windows.win_shell: |
    # Disable Extended Protection for Authentication (EPA) on IIS
    Import-Module WebAdministration
    
    $site = Get-Website | Where-Object { $_.Name -like "*Orchestrator*Web*" } | Select-Object -First 1
    
    if ($site) {
      $sitePath = "IIS:\Sites\$($site.Name)"
      
      # Disable Extended Protection
      Set-WebConfigurationProperty -Filter "/system.webServer/security/authentication/windowsAuthentication/extendedProtection" `
        -Name "tokenChecking" -Value "None" -PSPath $sitePath -ErrorAction SilentlyContinue
      
      Write-Output "NTLM channel binding disabled for relay testing"
    }
  when: ludus_scorch_disable_ntlm_channel_binding
  failed_when: false

- name: Open firewall ports for web services
  community.windows.win_firewall_rule:
    name: "SCORCH {{ item.name }}"
    localport: "{{ item.port }}"
    action: allow
    direction: in
    protocol: tcp
    state: present
    enabled: true
  loop:
    - { name: "Web API", port: "{{ ludus_scorch_api_port }}" }
    - { name: "Console", port: "{{ ludus_scorch_console_port }}" }

- name: Restart IIS
  ansible.windows.win_shell: iisreset /restart
  failed_when: false

- name: Verify Web API is accessible
  ansible.windows.win_uri:
    url: "http://localhost:{{ ludus_scorch_api_port }}/Orchestrator2012/Orchestrator.svc/"
    method: GET
    status_code: [200, 401]
  register: api_check
  retries: 10
  delay: 15
  until: api_check.status_code in [200, 401]

- name: Display installation status
  ansible.builtin.debug:
    msg: |
      SCORCH Web Services Installation Complete
      Web API URL: {{ ludus_scorch_api_url }}
      Console URL: {{ ludus_scorch_console_url }}
      Anonymous Access: {{ ludus_scorch_enable_anonymous_access }}
