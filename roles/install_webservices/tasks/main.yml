---
# Install SCORCH Web API and Console

- name: Set computed variables
  ansible.builtin.set_fact:
    ludus_scorch_web_account_full: "{{ ludus_domain_netbios_name | default('YOURNAMESPACE') }}\\{{ ludus_scorch_web_account }}"
    ludus_scorch_db_connection: "{{ ludus_scorch_db_server }}{% if ludus_scorch_db_instance | length > 0 %}\\{{ ludus_scorch_db_instance }}{% endif %}"
    ludus_scorch_api_url: "{{ ludus_scorch_api_public_url | default('http://' + ansible_fqdn + ':' + ludus_scorch_api_port | string + '/Orchestrator2012/Orchestrator.svc', true) }}"
    ludus_scorch_console_url: "{{ ludus_scorch_console_public_url | default('http://' + ansible_fqdn + ':' + ludus_scorch_console_port | string, true) }}"


- name: Create temp directory
  ansible.windows.win_file:
    path: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}"
    state: directory

- name: Check if SCORCH Web Services are already installed
  ansible.windows.win_shell: |
    $site = Get-Website -Name "Microsoft System Center*Orchestrator*" -ErrorAction SilentlyContinue
    if ($site) { Write-Output "installed" } else { Write-Output "not_installed" }
  register: scorch_web_check
  changed_when: false

- name: Skip installation if already installed
  ansible.builtin.debug:
    msg: "SCORCH Web Services are already installed"
  when: scorch_web_check.stdout | trim == "installed"

# Check if setup already exists
- name: Check if SCORCH setup already extracted
  ansible.windows.win_find:
    paths: "{{ ludus_scorch_setup_folder }}"
    patterns: "SetupOrchestrator.exe"
    recurse: yes
  register: existing_setup
  when: scorch_web_check.stdout | trim == "not_installed"
  failed_when: false

# Download if needed
- name: Create ludus directory
  ansible.windows.win_file:
    path: "C:\\ludus"
    state: directory
  when:
    - scorch_web_check.stdout | trim == "not_installed"
    - existing_setup.files | default([]) | length == 0

- name: Download SCORCH setup from Microsoft
  ansible.windows.win_get_url:
    url: "{{ ludus_scorch_download_url }}"
    dest: "{{ ludus_scorch_setup_zip }}"
    force: no
  when:
    - scorch_web_check.stdout | trim == "not_installed"
    - existing_setup.files | default([]) | length == 0

- name: Create SCORCH setup folder
  ansible.windows.win_file:
    path: "{{ ludus_scorch_setup_folder }}"
    state: directory
  when:
    - scorch_web_check.stdout | trim == "not_installed"
    - existing_setup.files | default([]) | length == 0

- name: Extract SCORCH zip file
  community.windows.win_unzip:
    src: "{{ ludus_scorch_setup_zip }}"
    dest: "{{ ludus_scorch_setup_folder }}"
  when:
    - scorch_web_check.stdout | trim == "not_installed"
    - existing_setup.files | default([]) | length == 0

# Find Setup.exe (in CdImage/Setup subfolder - required for silent install)
- name: Find Setup.exe
  ansible.windows.win_find:
    paths: "{{ ludus_scorch_setup_folder }}"
    patterns: "Setup.exe"
    recurse: yes
  register: setup_exe_find
  when: scorch_web_check.stdout | trim == "not_installed"

- name: Fail if Setup.exe not found
  ansible.builtin.fail:
    msg: "Setup.exe not found in {{ ludus_scorch_setup_folder }}"
  when:
    - scorch_web_check.stdout | trim == "not_installed"
    - setup_exe_find.files | length == 0

- name: Set SCORCH setup path
  ansible.builtin.set_fact:
    ludus_scorch_setup_path: "{{ setup_exe_find.files[0].path }}"
  when:
    - scorch_web_check.stdout | trim == "not_installed"
    - setup_exe_find.files | length > 0

- name: Add web service account to local Administrators
  ansible.windows.win_group_membership:
    name: Administrators
    members:
      - "{{ ludus_scorch_web_account_full }}"
    state: present
  failed_when: false

- name: Grant Log on as a Service right
  ansible.windows.win_user_right:
    name: SeServiceLogonRight
    users:
      - "{{ ludus_scorch_web_account_full }}"
    action: add

- name: Grant IIS Metabase permissions
  ansible.windows.win_shell: |
    $path = "C:\Windows\Microsoft.NET\Framework64\v4.0.30319\aspnet_regiis.exe"
    if (Test-Path $path) {
      & $path -ga "{{ ludus_scorch_web_account_full }}"
    }
  failed_when: false

# =============================================================================
# SCORCH WEB SERVICES INSTALLATION - Using Scheduled Task for Interactive Session
# =============================================================================

- name: Create temp directory
  ansible.windows.win_file:
    path: "{{ ludus_scorch_temp_dir | default('C:\\ludus_scorch_temp') }}"
    state: directory
  when: scorch_web_check.stdout | trim == "not_installed"

- name: Create SCORCH Web Services install script
  ansible.windows.win_copy:
    dest: "{{ ludus_scorch_temp_dir | default('C:\\ludus_scorch_temp') }}\\Install-SCORCH-Web.ps1"
    content: |
      $ErrorActionPreference = "Stop"
      $logFile = "{{ ludus_scorch_temp_dir | default('C:\\ludus_scorch_temp') }}\scorch_web_install.log"
      
      Start-Transcript -Path $logFile -Append
      
      $env:SEE_MASK_NOZONECHECKS = 1
      
      $setupPath = "{{ ludus_scorch_setup_path }}"
      $exitCodeFile = "{{ ludus_scorch_temp_dir | default('C:\\ludus_scorch_temp') }}\scorch_web_exit_code.txt"
      
      # Install WebAPI and WebConsole together in one command
      Write-Output "Installing SCORCH Web Services (WebAPI + WebConsole)..."
      $installArgs = @(
        '/Silent',
        '/ServiceUserName:{{ ludus_scorch_web_account_full }}',
        '/ServicePassword:{{ ludus_scorch_web_password }}',
        '/Components:WebAPI,WebConsole',
        '/DbServer:{{ ludus_scorch_db_connection }}',
        '/DbNameExisting:{{ ludus_scorch_db_name }}',
        '/TrustServerCertificate:{{ ludus_scorch_db_trust_cert | lower }}',
        '/WebServicePort:{{ ludus_scorch_api_port }}',
        '/WebConsolePort:{{ ludus_scorch_console_port }}',
        '/WebServicePublicUrl:"{{ ludus_scorch_api_url }}"',
        '/UseMicrosoftUpdate:{% if ludus_scorch_use_microsoft_update %}1{% else %}0{% endif %}',
        '/SendTelemetryReports:{% if ludus_scorch_send_telemetry %}1{% else %}0{% endif %}',
        '/EnableErrorReporting:{{ ludus_scorch_error_reporting }}'
      )
      
      Write-Output "Install Arguments: $($installArgs -join ' ')"
      
      try {
        $process = Start-Process -FilePath $setupPath -ArgumentList $installArgs -Wait -PassThru -NoNewWindow
        $exitCode = $process.ExitCode
        Write-Output "Installation completed with exit code: $exitCode"
        
        if ($exitCode -ne 0 -and $exitCode -ne 3010 -and $exitCode -ne -15) {
          Write-Error "Web Services installation failed with exit code: $exitCode"
          $exitCode | Out-File -FilePath $exitCodeFile -Force
          Stop-Transcript
          exit $exitCode
        }
        
        # Success - write exit code file
        $exitCode | Out-File -FilePath $exitCodeFile -Force
        Stop-Transcript
        exit $exitCode
      } catch {
        Write-Error "Web Services installation failed: $_"
        999 | Out-File -FilePath $exitCodeFile -Force
        Stop-Transcript
        exit 999
      }
  when: scorch_web_check.stdout | trim == "not_installed"

- name: Remove any existing SCORCH Web install scheduled task
  community.windows.win_scheduled_task:
    name: "SCORCH_Web_Install"
    state: absent
  when: scorch_web_check.stdout | trim == "not_installed"

- name: Create scheduled task for SCORCH Web Services installation
  community.windows.win_scheduled_task:
    name: "SCORCH_Web_Install"
    description: "Install SCORCH Web Services in interactive session"
    actions:
      - path: powershell.exe
        arguments: '-ExecutionPolicy Bypass -File "{{ ludus_scorch_temp_dir | default(''C:\\ludus_scorch_temp'') }}\Install-SCORCH-Web.ps1"'
    triggers:
      - type: registration
    username: '{{ ludus_domain_fqdn }}\{{ ludus_scorch_domain_admin }}'
    password: '{{ ludus_scorch_domain_admin_password }}'
    logon_type: interactive_token
    run_level: highest
    state: present
    enabled: true
  when: scorch_web_check.stdout | trim == "not_installed"
  register: sched_task_created

- name: Run the SCORCH Web install scheduled task
  ansible.windows.win_shell: |
    Start-ScheduledTask -TaskName "SCORCH_Web_Install"
  when: 
    - scorch_web_check.stdout | trim == "not_installed"
    - sched_task_created is changed

- name: Wait for SCORCH Web installation to complete
  ansible.windows.win_wait_for:
    path: "{{ ludus_scorch_temp_dir | default('C:\\ludus_scorch_temp') }}\\scorch_web_exit_code.txt"
    timeout: 3600
  when: scorch_web_check.stdout | trim == "not_installed"

- name: Get installation exit code
  ansible.windows.win_shell: |
    Get-Content "{{ ludus_scorch_temp_dir | default('C:\\ludus_scorch_temp') }}\scorch_web_exit_code.txt"
  register: install_exit_code
  when: scorch_web_check.stdout | trim == "not_installed"

- name: Check installation result
  ansible.builtin.fail:
    msg: "SCORCH Web Services installation failed with exit code: {{ install_exit_code.stdout | trim }}"
  when:
    - scorch_web_check.stdout | trim == "not_installed"
    - install_exit_code.stdout | trim not in ['0', '3010', '-15']

- name: Remove SCORCH Web install scheduled task
  community.windows.win_scheduled_task:
    name: "SCORCH_Web_Install"
    state: absent
  when: scorch_web_check.stdout | trim == "not_installed"

- name: Configure anonymous access for testing
  ansible.windows.win_shell: |
    Import-Module WebAdministration
    
    # Find the SCORCH web site
    $site = Get-Website | Where-Object { $_.Name -like "*Orchestrator*Web*" } | Select-Object -First 1
    
    if ($site) {
      $sitePath = "IIS:\Sites\$($site.Name)"
      
      # Enable anonymous authentication
      Set-WebConfigurationProperty -Filter "/system.webServer/security/authentication/anonymousAuthentication" `
        -Name "enabled" -Value $true -PSPath $sitePath
      
      # Disable Windows authentication
      Set-WebConfigurationProperty -Filter "/system.webServer/security/authentication/windowsAuthentication" `
        -Name "enabled" -Value $false -PSPath $sitePath
      
      Write-Output "Anonymous access enabled for $($site.Name)"
    }
  when: ludus_scorch_enable_anonymous_access

- name: Configure NTLM without channel binding (for relay testing)
  ansible.windows.win_shell: |
    # Disable Extended Protection for Authentication (EPA) on IIS
    Import-Module WebAdministration
    
    $site = Get-Website | Where-Object { $_.Name -like "*Orchestrator*Web*" } | Select-Object -First 1
    
    if ($site) {
      $sitePath = "IIS:\Sites\$($site.Name)"
      
      # Disable Extended Protection
      Set-WebConfigurationProperty -Filter "/system.webServer/security/authentication/windowsAuthentication/extendedProtection" `
        -Name "tokenChecking" -Value "None" -PSPath $sitePath -ErrorAction SilentlyContinue
      
      Write-Output "NTLM channel binding disabled for relay testing"
    }
  when: ludus_scorch_disable_ntlm_channel_binding
  failed_when: false

# Grant SQL permissions for Web API service account
- name: Grant SQL permissions for Web API service account
  ansible.windows.win_shell: |
    $server = "{{ ludus_scorch_db_connection }}"
    $database = "{{ ludus_scorch_db_name }}"
    $account = "{{ ludus_domain_netbios_name }}\{{ ludus_scorch_web_account }}"
    
    $connString = "Server=$server;Database=$database;Integrated Security=True;TrustServerCertificate={{ 'True' if ludus_scorch_db_trust_cert else 'False' }}"
    $conn = New-Object System.Data.SqlClient.SqlConnection($connString)
    $conn.Open()
    
    # Grant SELECT and EXECUTE on SCORCH schemas
    $grants = @(
      "GRANT SELECT ON SCHEMA::[Microsoft.SystemCenter.Orchestrator] TO [$account]",
      "GRANT SELECT ON SCHEMA::[Microsoft.SystemCenter.Orchestrator.Internal] TO [$account]",
      "GRANT EXECUTE ON SCHEMA::[Microsoft.SystemCenter.Orchestrator] TO [$account]",
      "GRANT EXECUTE ON SCHEMA::[Microsoft.SystemCenter.Orchestrator.Internal] TO [$account]"
    )
    
    foreach ($grant in $grants) {
      try {
        $cmd = $conn.CreateCommand()
        $cmd.CommandText = $grant
        $cmd.ExecuteNonQuery() | Out-Null
        Write-Host "Executed: $grant"
      } catch {
        Write-Host "Warning: $grant - $_"
      }
    }
    
    $conn.Close()
    Write-Host "SQL permissions granted for Web API service account"
  vars:
    ansible_become: true
    ansible_become_method: runas
    ansible_become_user: '{{ ludus_domain_fqdn }}\{{ ludus_scorch_domain_admin }}'
    ansible_become_password: '{{ ludus_scorch_domain_admin_password }}'
    ansible_become_flags: "logon_type=interactive logon_flags=with_profile"
  register: sql_grant_result
  failed_when: false
  changed_when: "'granted' in sql_grant_result.stdout"

- name: Open firewall ports for web services
  community.windows.win_firewall_rule:
    name: "SCORCH {{ item.name }}"
    localport: "{{ item.port }}"
    action: allow
    direction: in
    protocol: tcp
    state: present
    enabled: true
  loop:
    - { name: "Web API", port: "{{ ludus_scorch_api_port }}" }
    - { name: "Console", port: "{{ ludus_scorch_console_port }}" }

- name: Restart IIS
  ansible.windows.win_shell: iisreset /restart
  failed_when: false

- name: Verify Web API is accessible
  ansible.windows.win_uri:
    url: "http://localhost:{{ ludus_scorch_api_port }}/Orchestrator2012/Orchestrator.svc/"
    method: GET
    status_code: [200, 401]
  register: api_check
  retries: 10
  delay: 15
  until: api_check.status_code in [200, 401]

- name: Display installation status
  ansible.builtin.debug:
    msg: |
      SCORCH Web Services Installation Complete
      Web API URL: {{ ludus_scorch_api_url }}
      Console URL: {{ ludus_scorch_console_url }}
      Anonymous Access: {{ ludus_scorch_enable_anonymous_access }}
