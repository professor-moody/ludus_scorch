---
# Install SQL Server for SCORCH

- name: Check if SQL Server is already installed
  ansible.windows.win_reg_stat:
    path: HKLM:\SOFTWARE\Microsoft\Microsoft SQL Server\Instance Names\SQL
  register: sql_installed

- name: Skip SQL installation if already installed
  ansible.builtin.debug:
    msg: "SQL Server is already installed, skipping installation"
  when: sql_installed.exists

- name: Create temp directory
  ansible.windows.win_file:
    path: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}"
    state: directory

- name: Check if SQL ISO exists
  ansible.windows.win_stat:
    path: "{{ ludus_scorch_sql_iso_path }}"
  register: sql_iso_stat
  when: 
    - ludus_scorch_sql_iso_path | length > 0
    - not sql_installed.exists

- name: Fail if SQL ISO not found and not already installed
  ansible.builtin.fail:
    msg: |
      SQL Server ISO not found at {{ ludus_scorch_sql_iso_path }}.
      Please upload the SQL Server ISO to the Ludus file share.
  when:
    - not sql_installed.exists
    - ludus_scorch_sql_iso_path | length > 0
    - not sql_iso_stat.stat.exists | default(false)

- name: Mount SQL Server ISO
  community.windows.win_disk_image:
    image_path: "{{ ludus_scorch_sql_iso_path }}"
    state: present
  register: sql_iso_mount
  when:
    - not sql_installed.exists
    - ludus_scorch_sql_iso_path | length > 0

- name: Set SQL setup path
  ansible.builtin.set_fact:
    ludus_scorch_sql_setup_full_path: "{{ sql_iso_mount.mount_paths[0] }}{{ ludus_scorch_sql_setup_path }}"
  when:
    - not sql_installed.exists
    - sql_iso_mount.mount_paths is defined

- name: Build SQL Server install arguments
  ansible.builtin.set_fact:
    sql_install_args: >-
      /Q
      /ACTION=Install
      /FEATURES={{ ludus_scorch_sql_features }}
      /INSTANCENAME={{ ludus_scorch_sql_instance_name }}
      /INSTANCEID={{ ludus_scorch_sql_instance_id }}
      /SQLCOLLATION={{ ludus_scorch_sql_collation }}
      /SQLSYSADMINACCOUNTS="{{ ludus_scorch_sql_admins | join('" "') }}"
      /SECURITYMODE=SQL
      /SAPWD="{{ ludus_scorch_sql_sa_password }}"
      /TCPENABLED=1
      /NPENABLED=1
      /IACCEPTSQLSERVERLICENSETERMS
      /UPDATEENABLED=False
      /INDICATEPROGRESS
  when: not sql_installed.exists

- name: Install SQL Server
  ansible.windows.win_shell: |
    $process = Start-Process -FilePath "{{ ludus_scorch_sql_setup_full_path }}" `
      -ArgumentList @(
        '/Q',
        '/ACTION=Install',
        '/FEATURES={{ ludus_scorch_sql_features }}',
        '/INSTANCENAME={{ ludus_scorch_sql_instance_name }}',
        '/INSTANCEID={{ ludus_scorch_sql_instance_id }}',
        '/SQLCOLLATION={{ ludus_scorch_sql_collation }}',
        '/SQLSYSADMINACCOUNTS="BUILTIN\Administrators"',
        '/SECURITYMODE=SQL',
        '/SAPWD="{{ ludus_scorch_sql_sa_password }}"',
        '/TCPENABLED=1',
        '/NPENABLED=1',
        '/IACCEPTSQLSERVERLICENSETERMS',
        '/UPDATEENABLED=False'
      ) -Wait -PassThru -NoNewWindow
    
    if ($process.ExitCode -eq 0 -or $process.ExitCode -eq 3010) {
      Write-Output "SQL Server installed successfully"
      exit 0
    } else {
      Write-Error "SQL Server installation failed with exit code: $($process.ExitCode)"
      exit $process.ExitCode
    }
  when: not sql_installed.exists
  register: sql_install
  async: 3600
  poll: 60

- name: Unmount SQL Server ISO
  community.windows.win_disk_image:
    image_path: "{{ ludus_scorch_sql_iso_path }}"
    state: absent
  when:
    - ludus_scorch_sql_iso_path | length > 0
    - sql_iso_mount.mount_paths is defined

- name: Ensure SQL Server service is running
  ansible.windows.win_service:
    name: "MSSQLSERVER"
    state: started
    start_mode: auto

- name: Ensure SQL Server Agent service is running
  ansible.windows.win_service:
    name: "SQLSERVERAGENT"
    state: started
    start_mode: auto
  failed_when: false

- name: Enable TCP/IP protocol
  ansible.windows.win_shell: |
    Import-Module SQLPS -DisableNameChecking
    $smo = 'Microsoft.SqlServer.Management.Smo.'
    $wmi = New-Object ($smo + 'Wmi.ManagedComputer')
    $uri = "ManagedComputer[@Name='$env:COMPUTERNAME']/ServerInstance[@Name='{{ ludus_scorch_sql_instance_name }}']/ServerProtocol[@Name='Tcp']"
    $tcp = $wmi.GetSmoObject($uri)
    $tcp.IsEnabled = $true
    $tcp.Alter()
    Write-Output "TCP/IP enabled"
  failed_when: false

- name: Configure SQL Server TCP port
  ansible.windows.win_shell: |
    Import-Module SQLPS -DisableNameChecking
    $smo = 'Microsoft.SqlServer.Management.Smo.'
    $wmi = New-Object ($smo + 'Wmi.ManagedComputer')
    $uri = "ManagedComputer[@Name='$env:COMPUTERNAME']/ServerInstance[@Name='{{ ludus_scorch_sql_instance_name }}']/ServerProtocol[@Name='Tcp']/IPAddress[@Name='IPAll']"
    $ipAll = $wmi.GetSmoObject($uri)
    $ipAll.IPAddressProperties['TcpPort'].Value = "{{ ludus_scorch_sql_tcp_port }}"
    $ipAll.IPAddressProperties['TcpDynamicPorts'].Value = ""
    $ipAll.Alter()
    Write-Output "TCP port configured to {{ ludus_scorch_sql_tcp_port }}"
  failed_when: false

- name: Restart SQL Server service
  ansible.windows.win_service:
    name: "MSSQLSERVER"
    state: restarted

- name: Open firewall for SQL Server
  community.windows.win_firewall_rule:
    name: "SQL Server (TCP {{ ludus_scorch_sql_tcp_port }})"
    localport: "{{ ludus_scorch_sql_tcp_port }}"
    action: allow
    direction: in
    protocol: tcp
    state: present
    enabled: true
  when: ludus_scorch_sql_open_firewall

- name: Verify SQL Server is accessible
  ansible.windows.win_shell: |
    $conn = New-Object System.Data.SqlClient.SqlConnection
    $conn.ConnectionString = "Server=localhost,{{ ludus_scorch_sql_tcp_port }};Database=master;User Id=sa;Password={{ ludus_scorch_sql_sa_password }};TrustServerCertificate=True"
    try {
      $conn.Open()
      $cmd = $conn.CreateCommand()
      $cmd.CommandText = "SELECT @@VERSION"
      $version = $cmd.ExecuteScalar()
      $conn.Close()
      Write-Output "SQL Server Version: $version"
    } catch {
      Write-Error "Failed to connect: $_"
      exit 1
    }
  register: sql_verify
  changed_when: false

- name: Display SQL Server status
  ansible.builtin.debug:
    msg: "{{ sql_verify.stdout_lines }}"
