---
# Install SCORCH Management Server

- name: Set computed variables
  ansible.builtin.set_fact:
    ludus_scorch_service_account_full: "{{ ludus_domain_netbios_name | default('YOURNAMESPACE') }}\\{{ ludus_scorch_svc_account }}"
    ludus_scorch_db_connection: "{{ ludus_scorch_db_server }}{% if ludus_scorch_db_instance | length > 0 %}\\{{ ludus_scorch_db_instance }}{% endif %}"

- name: Create temp directory
  ansible.windows.win_file:
    path: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}"
    state: directory

# =============================================================================
# PREREQUISITES - SCORCH 2022 requires VC++, IIS, .NET 5/6 Hosting Bundles
# IMPORTANT: IIS must be installed BEFORE .NET Hosting Bundles for module registration
# =============================================================================
- name: Check if VC++ Redistributable is installed
  ansible.windows.win_shell: |
    $vcRedist = Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\VisualStudio\14.0\VC\Runtimes\X64" -ErrorAction SilentlyContinue
    if ($vcRedist -and $vcRedist.Version -ge "14.34") { Write-Output "installed" } else { Write-Output "not_installed" }
  register: vcredist_check
  changed_when: false

- name: Download Visual C++ Redistributable 2015-2022
  ansible.windows.win_get_url:
    url: "https://aka.ms/vs/17/release/vc_redist.x64.exe"
    dest: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\vc_redist.x64.exe"
  when: vcredist_check.stdout | trim == "not_installed"

- name: Install Visual C++ Redistributable 2015-2022
  ansible.windows.win_package:
    path: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\vc_redist.x64.exe"
    arguments: /install /quiet /norestart
    state: present
  when: vcredist_check.stdout | trim == "not_installed"
  register: vcredist_install

# IIS MUST be installed BEFORE .NET Hosting Bundles for ASP.NET Core module registration
- name: Install IIS with required features
  ansible.windows.win_feature:
    name:
      - Web-Server
      - Web-WebServer
      - Web-Common-Http
      - Web-Default-Doc
      - Web-Dir-Browsing
      - Web-Http-Errors
      - Web-Static-Content
      - Web-Health
      - Web-Http-Logging
      - Web-Performance
      - Web-Stat-Compression
      - Web-Security
      - Web-Filtering
      - Web-Windows-Auth
      - Web-App-Dev
      - Web-Net-Ext45
      - Web-Asp-Net45
      - Web-ISAPI-Ext
      - Web-ISAPI-Filter
      - Web-Mgmt-Tools
      - Web-Mgmt-Console
      - NET-Framework-45-ASPNET
      - NET-WCF-HTTP-Activation45
    state: present
  register: iis_install

# .NET 5 Hosting Bundle - Required by SCORCH 2022 Web API
- name: Check if .NET 5 Hosting Bundle is installed
  ansible.windows.win_shell: |
    $dotnet5 = Get-ItemProperty "HKLM:\SOFTWARE\dotnet\Setup\InstalledVersions\x64\sharedfx\Microsoft.AspNetCore.App" -ErrorAction SilentlyContinue
    if ($dotnet5 -and $dotnet5.PSObject.Properties.Name -match "5\.") { Write-Output "installed" } else { Write-Output "not_installed" }
  register: dotnet5_check
  changed_when: false

- name: Download .NET 5 Hosting Bundle
  ansible.windows.win_get_url:
    url: "https://download.visualstudio.microsoft.com/download/pr/5cc93fce-45cc-4cfe-a206-be05c02814e3/0e9568e61d79ac7fa8c09d8937f9eb54/dotnet-hosting-5.0.17-win.exe"
    dest: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\dotnet-hosting-5.0.exe"
  when: dotnet5_check.stdout | trim == "not_installed"

- name: Install .NET 5 Hosting Bundle
  ansible.windows.win_package:
    path: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\dotnet-hosting-5.0.exe"
    arguments: /install /quiet /norestart
    state: present
  when: dotnet5_check.stdout | trim == "not_installed"
  register: dotnet5_install

# .NET 6 Hosting Bundle - Required by SCORCH 2022 Web API
- name: Check if .NET 6 Hosting Bundle is installed
  ansible.windows.win_shell: |
    $dotnet6 = Get-ItemProperty "HKLM:\SOFTWARE\dotnet\Setup\InstalledVersions\x64\sharedfx\Microsoft.AspNetCore.App" -ErrorAction SilentlyContinue
    if ($dotnet6 -and $dotnet6.PSObject.Properties.Name -match "6\.") { Write-Output "installed" } else { Write-Output "not_installed" }
  register: dotnet6_check
  changed_when: false

- name: Download .NET 6 Hosting Bundle
  ansible.windows.win_get_url:
    url: "https://builds.dotnet.microsoft.com/dotnet/aspnetcore/Runtime/6.0.36/dotnet-hosting-6.0.36-win.exe"
    dest: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\dotnet-hosting-6.0.exe"
  when: dotnet6_check.stdout | trim == "not_installed"

- name: Install .NET 6 Hosting Bundle
  ansible.windows.win_package:
    path: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\dotnet-hosting-6.0.exe"
    arguments: /install /quiet /norestart
    state: present
  when: dotnet6_check.stdout | trim == "not_installed"
  register: dotnet6_install

# Microsoft OLE DB Driver for SQL Server v18 - Required for Management Server
- name: Check if OLE DB Driver is installed
  ansible.windows.win_shell: |
    $oledb = Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\MSOLEDBSQL" -ErrorAction SilentlyContinue
    if ($oledb) { Write-Output "installed" } else { Write-Output "not_installed" }
  register: oledb_check
  changed_when: false

- name: Download Microsoft OLE DB Driver for SQL Server
  ansible.windows.win_get_url:
    url: "https://go.microsoft.com/fwlink/?linkid=2242656"
    dest: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\msoledbsql.msi"
  when: oledb_check.stdout | trim == "not_installed"

- name: Install Microsoft OLE DB Driver for SQL Server
  ansible.windows.win_package:
    path: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\msoledbsql.msi"
    arguments: /quiet /norestart IACCEPTMSOLEDBSQLLICENSETERMS=YES
    state: present
  when: oledb_check.stdout | trim == "not_installed"
  register: oledb_install

# IIS URL Rewrite Module - Required by SCORCH prereq checker
- name: Check if IIS URL Rewrite is installed
  ansible.windows.win_shell: |
    $urlRewrite = Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\IIS Extensions\URL Rewrite" -ErrorAction SilentlyContinue
    if ($urlRewrite) { Write-Output "installed" } else { Write-Output "not_installed" }
  register: urlrewrite_check
  changed_when: false

- name: Download IIS URL Rewrite Module
  ansible.windows.win_get_url:
    url: "https://download.microsoft.com/download/1/2/8/128E2E22-C1B9-44A4-BE2A-5859ED1D4592/rewrite_amd64_en-US.msi"
    dest: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\rewrite_amd64.msi"
  when: urlrewrite_check.stdout | trim == "not_installed"

- name: Install IIS URL Rewrite Module
  ansible.windows.win_package:
    path: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\rewrite_amd64.msi"
    arguments: /quiet /norestart
    state: present
  when: urlrewrite_check.stdout | trim == "not_installed"
  register: urlrewrite_install

# IIS CORS Module - Required by SCORCH prereq checker
- name: Check if IIS CORS Module is installed
  ansible.windows.win_shell: |
    $cors = Get-WebConfigurationProperty -pspath 'MACHINE/WEBROOT/APPHOST' -filter "system.webServer/cors" -name "." -ErrorAction SilentlyContinue
    if ($cors) { Write-Output "installed" } else { Write-Output "not_installed" }
  register: cors_check
  changed_when: false
  ignore_errors: true

- name: Download IIS CORS Module
  ansible.windows.win_get_url:
    url: "https://go.microsoft.com/fwlink/?linkid=862444"
    dest: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\iiscors_amd64.msi"
  when: cors_check.stdout | default('not_installed') | trim == "not_installed"

- name: Install IIS CORS Module
  ansible.windows.win_package:
    path: "{{ ludus_scorch_temp_dir | default('C:\\\\ludus_scorch_temp') }}\\iiscors_amd64.msi"
    arguments: /quiet /norestart
    state: present
  when: cors_check.stdout | default('not_installed') | trim == "not_installed"
  register: cors_install

- name: Reboot if prerequisites were installed
  ansible.windows.win_reboot:
    reboot_timeout: 600
  when: (vcredist_install.changed | default(false)) or (iis_install.changed | default(false)) or (dotnet5_install.changed | default(false)) or (dotnet6_install.changed | default(false)) or (oledb_install.changed | default(false)) or (urlrewrite_install.changed | default(false)) or (cors_install.changed | default(false))

- name: Check if SCORCH Management Server is already installed
  ansible.windows.win_service_info:
    name: OrchestratorManagement
  register: scorch_mgmt_service
  failed_when: false

- name: Skip installation if already installed
  ansible.builtin.debug:
    msg: "SCORCH Management Server is already installed"
  when: scorch_mgmt_service.services | length > 0

# Check if setup already exists (extracted)
- name: Check if SCORCH setup already extracted
  ansible.windows.win_find:
    paths: "{{ ludus_scorch_setup_folder }}"
    patterns: "SetupOrchestrator.exe"
    recurse: yes
  register: existing_setup
  when: scorch_mgmt_service.services | length == 0
  failed_when: false

# Download if needed
- name: Create ludus directory
  ansible.windows.win_file:
    path: "C:\\ludus"
    state: directory
  when:
    - scorch_mgmt_service.services | length == 0
    - existing_setup.files | default([]) | length == 0

- name: Download SCORCH setup from Microsoft
  ansible.windows.win_get_url:
    url: "{{ ludus_scorch_download_url }}"
    dest: "{{ ludus_scorch_setup_zip }}"
    force: no
  when:
    - scorch_mgmt_service.services | length == 0
    - existing_setup.files | default([]) | length == 0
  register: scorch_download

- name: Create SCORCH setup folder
  ansible.windows.win_file:
    path: "{{ ludus_scorch_setup_folder }}"
    state: directory
  when:
    - scorch_mgmt_service.services | length == 0
    - existing_setup.files | default([]) | length == 0

- name: Extract SCORCH zip file
  community.windows.win_unzip:
    src: "{{ ludus_scorch_setup_zip }}"
    dest: "{{ ludus_scorch_setup_folder }}"
  when:
    - scorch_mgmt_service.services | length == 0
    - existing_setup.files | default([]) | length == 0
  register: zip_extract

# Find SetupOrchestrator.exe (it's in CdImage subfolder)
- name: Find SetupOrchestrator.exe
  ansible.windows.win_find:
    paths: "{{ ludus_scorch_setup_folder }}"
    patterns: "SetupOrchestrator.exe"
    recurse: yes
  register: setup_exe_find
  when: scorch_mgmt_service.services | length == 0

- name: Fail if SetupOrchestrator.exe not found
  ansible.builtin.fail:
    msg: "SetupOrchestrator.exe not found in {{ ludus_scorch_setup_folder }}"
  when:
    - scorch_mgmt_service.services | length == 0
    - setup_exe_find.files | length == 0

- name: Set SCORCH setup path
  ansible.builtin.set_fact:
    ludus_scorch_setup_path: "{{ setup_exe_find.files[0].path }}"
  when:
    - scorch_mgmt_service.services | length == 0
    - setup_exe_find.files | length > 0

- name: Add service account to local Administrators
  ansible.windows.win_group_membership:
    name: Administrators
    members:
      - "{{ ludus_scorch_service_account_full }}"
    state: present
  failed_when: false

- name: Grant Log on as a Service right
  ansible.windows.win_user_right:
    name: SeServiceLogonRight
    users:
      - "{{ ludus_scorch_service_account_full }}"
    action: add

- name: Get Orchestrator Users Group SID
  ansible.windows.win_shell: |
    try {
      $group = Get-ADGroup "{{ ludus_scorch_users_group }}" -ErrorAction Stop
      Write-Output $group.SID.Value
    } catch {
      # Try local group
      $group = Get-LocalGroup "{{ ludus_scorch_users_group }}" -ErrorAction SilentlyContinue
      if ($group) {
        Write-Output $group.SID.Value
      } else {
        Write-Output ""
      }
    }
  register: users_group_sid
  changed_when: false
  failed_when: false

- name: Install SCORCH Management Server
  ansible.windows.win_shell: |
    $ErrorActionPreference = "Stop"
    $env:SEE_MASK_NOZONECHECKS = 1
    
    $args = @(
      '/Silent',
      '/ServiceUserName:{{ ludus_scorch_service_account_full }}',
      '/ServicePassword:{{ ludus_scorch_svc_password }}',
      '/Components:{{ ludus_scorch_components }}',
      '/DbServer:{{ ludus_scorch_db_connection }}',
      '/DbNameNew:{{ ludus_scorch_db_name }}',
      '/TrustServerCertificate:{{ ludus_scorch_db_trust_cert | lower }}',
      '/UseMicrosoftUpdate:{% if ludus_scorch_use_microsoft_update %}1{% else %}0{% endif %}',
      '/SendTelemetryReports:{% if ludus_scorch_send_telemetry %}1{% else %}0{% endif %}',
      '/EnableErrorReporting:{{ ludus_scorch_error_reporting }}'
    )
    
    {% if users_group_sid.stdout | trim | length > 0 %}
    $args += '/OrchestratorUsersGroup:{{ users_group_sid.stdout | trim }}'
    {% endif %}
    
    {% if ludus_scorch_enable_remote_designer %}
    $args += '/OrchestratorRemote'
    {% endif %}
    
    Write-Output "Starting SCORCH installation with arguments:"
    Write-Output ($args -join "`n")
    
    $process = Start-Process -FilePath "{{ ludus_scorch_setup_path }}" `
      -ArgumentList $args `
      -Wait -PassThru -NoNewWindow
    
    if ($process.ExitCode -eq 0 -or $process.ExitCode -eq 3010) {
      Write-Output "SCORCH Management Server installed successfully"
      exit 0
    } else {
      Write-Error "Installation failed with exit code: $($process.ExitCode)"
      # Check setup log
      $logPath = "$env:LOCALAPPDATA\SCO\LOGS"
      if (Test-Path $logPath) {
        Get-ChildItem $logPath -Filter "*.log" | Sort-Object LastWriteTime -Descending | Select-Object -First 1 | Get-Content -Tail 50
      }
      exit $process.ExitCode
    }
  vars:
    ansible_become: true
    ansible_become_method: runas
    ansible_become_user: '{{ ludus_domain_fqdn }}\{{ defaults.ad_domain_admin }}'
    ansible_become_password: '{{ defaults.ad_domain_admin_password }}'
    ansible_become_flags: "logon_type=interactive logon_flags=with_profile"
  when: scorch_mgmt_service.services | length == 0
  register: scorch_install
  async: 3600
  poll: 60

- name: Wait for Management Server service to start
  ansible.windows.win_service:
    name: OrchestratorManagement
    state: started
    start_mode: auto
  register: mgmt_service
  retries: 10
  delay: 30
  until: mgmt_service is succeeded

- name: Verify Management Server is running
  ansible.windows.win_shell: |
    $service = Get-Service -Name OrchestratorManagement
    Write-Output "Management Server Status: $($service.Status)"
    if ($service.Status -eq 'Running') { exit 0 } else { exit 1 }
  register: mgmt_verify
  changed_when: false

- name: Display installation status
  ansible.builtin.debug:
    msg: |
      SCORCH Management Server Installation Complete
      Service Status: {{ mgmt_verify.stdout }}
      Database: {{ ludus_scorch_db_connection }}\{{ ludus_scorch_db_name }}
